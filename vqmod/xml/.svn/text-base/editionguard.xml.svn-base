<!--
/*
 * @support
 * http://www.opensourcetechnologies.com/contactus.html
 * sales@opensourcetechnologies.com
 * */
-->
<modification>  
   <id>Edition Guard</id>
   <version>1.0.0</version>
   <vqmver>2.5.1</vqmver>
   <author>OST</author>
   <file name="catalog/language/*/mail/order.php">
	   <operation>
		   <search position="after"><![CDATA[$_['text_update_link']          = 'To view your order click on the link below:';]]></search>
		   <add>
			   <![CDATA[
				$_['text_editionguard']          = ' Download ';
				]]>
		   </add>
	   </operation>
   </file>
			
   <file name="catalog/view/theme/*/template/mail/order.tpl">
	   <operation>
		   <search position="replace" index='2'><![CDATA[<?php } ?></td>]]></search>
		   <add>
			   <![CDATA[
				<?php } ?></br><a href="<?php echo $product['editionguardurl']; ?>"><?php echo $text_editionguard; ?></a></td>
				]]>
		   </add>
	   </operation>
   </file>				
			   
   <file name="catalog/model/checkout/order.php">
	   <operation>
		   <search position="after"><![CDATA[$data['text_footer'] = $language->get('text_new_footer');]]></search>
		   <add>
			   <![CDATA[
				$data['text_editionguard'] = $language->get('text_editionguard');
				]]>
		   </add>
	   </operation>
	   <operation>
		   <search position="after"><![CDATA[$data['text_footer'] = $language->get('text_new_footer');]]></search>
		   <add>
			   <![CDATA[
				$dateval=time(); 
				$sharedSecret = $this->config->get('editionguard_secret'); // Place your unique distributor shared secret, keep this safe or the api can be used in your stead by others!
				$transactionId = $order_id; // Must be a unique value, generated by you for your records
				$linkURL = "http://acs4.editionguard.com/fulfillment/URLLink.acsm"; // Content server service url, do not change.
				$orderSource = $this->config->get('editionguard_email'); // Your EditionGuard subscription e-mail address.
				]]>
		   </add>
	   </operation>
	   <operation>
		   <search position="before"><![CDATA[$data['products'][] = array(]]></search>
		   <add>
			   <![CDATA[
				$q=$this->db->query("select resource from `". DB_PREFIX ."product` where product_id='".$product['product_id']."'");
					
					$resourceId = $q->row['resource']; // Place Content Server Resource ID starting with urn:uuid:
					// Create download URL
					$URL = "action=enterorder&ordersource=".urlencode($orderSource)."&orderid=".urlencode($transactionId)."&resid=".urlencode("$resourceId")."&dateval=".urlencode($dateval)."&gblver=4";
					 /* If you want the eBook to expire after a certain period of time,
					append the "rights" parameter to the link as shown below. 
					If not, simply omit this parameter. 
					The time period for the below example is three days. 
					We convert it into seconds using the formula: 
					3 days x 24 hours x 60 minutes x 60 seconds */
					$URL .= "&rights=$".urlencode("urt#").(3 * 24 * 60 * 60)."$";
					
					// Digitaly sign the request
					$URL = $linkURL."?".$URL."&auth=".hash_hmac("sha1", $URL, base64_decode($sharedSecret));
				]]>
		   </add>
	   </operation>
	   <operation>
		   <search position="after"><![CDATA['quantity' => $product['quantity'],]]></search>
		   <add>
			   <![CDATA[
				'editionguardurl'	   => $URL,	
				]]>
		   </add>
	   </operation>
   </file>
   <file name="catalog/language/*/account/order.php">
	   <operation>
		   <search position="after"><![CDATA[$_['text_error']            = 'The order you requested could not be found!';]]></search>
		   <add>
			   <![CDATA[
				$_['text_editionguard']          = ' Download ';
				]]>
		   </add>
	   </operation>
   </file>
			
   <file name="catalog/view/theme/*/template/account/order_info.tpl">
	   <operation>
		   <search position="replace" index='2'><![CDATA[<?php } ?></td>]]></search>
		   <add>
			   <![CDATA[
				<?php } ?></br><a href="<?php echo $product['editionguardurl']; ?>"><?php echo $text_editionguard; ?></a></td>
				]]>
		   </add>
	   </operation>
   </file>				
			   
   <file name="catalog/controller/account/order.php">
	   <operation>
		   <search position="after"><![CDATA[$data['text_comment'] = $this->language->get('text_comment');]]></search>
		   <add>
			   <![CDATA[
				$data['text_editionguard'] = $this->language->get('text_editionguard');
				]]>
		   </add>
	   </operation>
	   <operation>
		   <search position="after"><![CDATA[$data['products'] = array();]]></search>
		   <add>
			   <![CDATA[
				$dateval=time(); 
				$sharedSecret = $this->config->get('editionguard_secret'); // Place your unique distributor shared secret, keep this safe or the api can be used in your stead by others!
				$transactionId = $this->request->get['order_id']; // Must be a unique value, generated by you for your records
				$linkURL = "http://acs4.editionguard.com/fulfillment/URLLink.acsm"; // Content server service url, do not change.
				$orderSource = $this->config->get('editionguard_email'); // Your EditionGuard subscription e-mail address.
				]]>
		   </add>
	   </operation>
	   <operation>
		   <search position="before"><![CDATA[$data['products'][] = array(]]></search>
		   <add>
			   <![CDATA[
				$q=$this->db->query("select resource from `". DB_PREFIX ."product` where product_id='".$product['product_id']."'");
					
					$resourceId = $q->row['resource']; // Place Content Server Resource ID starting with urn:uuid:
					// Create download URL
					$URL = "action=enterorder&ordersource=".urlencode($orderSource)."&orderid=".urlencode($transactionId)."&resid=".urlencode("$resourceId")."&dateval=".urlencode($dateval)."&gblver=4";
					 /* If you want the eBook to expire after a certain period of time,
					append the "rights" parameter to the link as shown below. 
					If not, simply omit this parameter. 
					The time period for the below example is three days. 
					We convert it into seconds using the formula: 
					3 days x 24 hours x 60 minutes x 60 seconds */
					$URL .= "&rights=$".urlencode("urt#").(3 * 24 * 60 * 60)."$";
					
					// Digitaly sign the request
					$URL = $linkURL."?".$URL."&auth=".hash_hmac("sha1", $URL, base64_decode($sharedSecret));
				]]>
		   </add>
	   </operation>
	   <operation>
		   <search position="after"><![CDATA['quantity' => $product['quantity'],]]></search>
		   <add>
			   <![CDATA[
				'editionguardurl'	   => $URL,	
				]]>
		   </add>
	   </operation>
   </file>
</modification>
